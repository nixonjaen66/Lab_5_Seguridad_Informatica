<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Chat Socket.IO UNA</title>
    <style>
      * { margin:0; padding:0; box-sizing:border-box; }
      body { font:13px Helvetica, Arial; }
      form { background:#000; padding:3px; position:fixed; bottom:0; width:100%; }
      form input { border:0; padding:10px; }
      form button { width:10%; background:rgb(130,224,255); border:none; padding:10px; }
      #messages { list-style-type:none; margin:0; padding:0; }
      #messages li { padding:5px 10px; }
      #messages li:nth-child(odd) { background:#eee; }
      #messages { margin-bottom:40px }
      #nombre, #m { display:inline-block; }
      #m { width:69%; margin-right:4px; }
      #nombre { width:20% }
      .msg-media { margin-top:6px; }
      .msg-media img, .msg-media iframe { max-width:100%; border-radius:6px; }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form id="chatForm" action="">
      <input id="nombre" autocomplete="off" placeholder="Username"/>
      <input id="m" autocomplete="off" placeholder="Escriba un mensaje o pegue una URL" />
      <button>Send</button>
    </form>

    <script src="https://cdn.socket.io/4.7.2/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var colorHexTxt = "";

      function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
        return color;
      }

      $(function () {
        var socket = io();

        $('#chatForm').on('submit', function(){
          var nombreTxt = $('#nombre').val() || "Anónimo";
          var mensajeTxt = $('#m').val();

          if (!colorHexTxt) colorHexTxt = getRandomColor();

          var jsonMsg = { nombre: nombreTxt, mensaje: mensajeTxt, color: colorHexTxt };
          socket.emit('Evento-Mensaje-Server', JSON.stringify(jsonMsg));
          $('#m').val('');
          return false;
        });

        function appendMessage(model) {
          // model: {nombre,color,kind,text|url|videoId}
          var li = document.createElement('li');

          var strong = document.createElement('strong');
          strong.style.color = model.color || '#000';
          strong.textContent = (model.nombre || 'Anónimo') + ': ';
          li.appendChild(strong);

          if (model.kind === 'image' && model.url) {
            // muestra enlace y vista previa
            var a = document.createElement('a');
            a.href = model.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
            a.textContent = model.url;
            li.appendChild(a);

            var wrap = document.createElement('div');
            wrap.className = 'msg-media';
            var img = document.createElement('img');
            img.alt = 'Imagen';
            img.referrerPolicy = 'no-referrer';
            img.loading = 'lazy';
            img.src = model.url;
            wrap.appendChild(img);
            li.appendChild(wrap);

          } else if (model.kind === 'youtube' && model.videoId) {
            // muestra el link y un iframe sandbox
            var link = 'https://www.youtube.com/watch?v=' + model.videoId;
            var a2 = document.createElement('a');
            a2.href = link; a2.target = '_blank'; a2.rel = 'noopener noreferrer';
            a2.textContent = link;
            li.appendChild(a2);

            var wrap2 = document.createElement('div');
            wrap2.className = 'msg-media';
            var iframe = document.createElement('iframe');
            iframe.width = '560';
            iframe.height = '315';
            iframe.src = 'https://www.youtube.com/embed/' + model.videoId;
            iframe.title = 'YouTube video';
            iframe.allow = 'accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen = true;
            iframe.referrerPolicy = 'no-referrer';
            iframe.sandbox = 'allow-same-origin allow-scripts allow-popups allow-presentation';
            wrap2.appendChild(iframe);
            li.appendChild(wrap2);

          } else {
            // texto plano seguro
            var span = document.createElement('span');
            span.textContent = model.text || '';
            li.appendChild(span);
          }

          document.getElementById('messages').appendChild(li);
          window.scrollTo(0, document.body.scrollHeight);
        }

        socket.on('Evento-Mensaje-Server', function(msg){
  try {
    var model = JSON.parse(msg);

    if (model.kind === 'blocked') {
      // opcional: log o contador
      console.warn('Mensaje bloqueado por validación (no mostrado). Usuario:', model.nombre || 'anónimo');
      return; // NO pintar ni mostrar nada
    }

    appendMessage(model);
  } catch (e) {
    appendMessage({ nombre:'Sistema', color:'#c00', kind:'text', text:'Mensaje inválido' });
  }
});

      });
    </script>
  </body>
</html>
